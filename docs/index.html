<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trading Signal Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .glass{background:rgba(255,255,255,.04);backdrop-filter:blur(8px)}
    .badge{padding:.25rem .5rem;border-radius:.5rem;border-width:1px;font-size:.75rem;line-height:1}
    .score-high{color:#22c55e;font-weight:600;}
    .score-mid{color:#eab308;font-weight:600;}
    .score-low{color:#ef4444;font-weight:600;}
    .subrow{background-color:rgba(255,255,255,.02); font-size:0.8rem;}
  </style>
</head>
<body class="bg-slate-950 text-slate-100">
  <header class="sticky top-0 z-40 bg-slate-950/70 backdrop-blur border-b border-white/10">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-9 w-9 grid place-items-center rounded-xl bg-emerald-500/15 text-emerald-400">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18M7 13v8M11 8v13M15 5v16M19 10v11"/></svg>
        </div>
        <div>
          <h1 class="text-lg font-semibold">Trading Signals</h1>
          <p class="text-xs text-slate-400">RSI/MACD/BB/ATR/Stoch + Entry score</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <span id="status" class="text-xs px-2 py-1 rounded-full border border-white/10">Yhteys...</span>
        <button id="refreshBtn" class="px-3 py-1.5 text-sm rounded-lg border border-emerald-500/30 bg-emerald-500/10 text-emerald-300 hover:bg-emerald-500/20">Päivitä nyt</button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
    <aside class="glass rounded-2xl border border-white/10 lg:order-1">
      <div class="px-4 py-3 border-b border-white/10 flex items-center justify-between">
        <div>
          <h2 class="font-semibold">Skanneri</h2>
          <p class="text-xs text-slate-400">US Major • MOST_ACTIVE • Top3 haulla</p>
        </div>
        <button id="scanBtn" class="px-3 py-2 text-sm rounded-md border border-white/10 bg-white/5 hover:bg-white/10">Skannaa</button>
      </div>
      <div class="p-4 flex items-center gap-2">
        <input id="searchInput" placeholder="Hae (esim. NV, AI, TECH)" class="flex-1 px-3 py-2 text-sm rounded-md bg-white/5 border border-white/10 placeholder:text-slate-500 focus:outline-none">
        <button id="searchBtn" class="px-3 py-2 text-sm rounded-md bg-sky-500/20 text-sky-300 border border-sky-500/30 hover:bg-sky-500/30">Hae Top3</button>
      </div>
      <div id="scanList" class="p-4 grid gap-3 text-sm"></div>

      <div class="p-4 pt-0">
        <h3 class="mt-2 text-sm font-semibold">Luotu promptti</h3>
        <textarea id="promptBox" rows="8" class="w-full mt-2 p-3 rounded-lg bg-white/5 border border-white/10 text-slate-200" placeholder="Tähän generoidut promptit"></textarea>
        <div class="mt-2 flex gap-2">
          <button id="copyPromptBtn" class="px-3 py-2 text-sm rounded-md border border-white/10 bg-white/5 hover:bg-white/10">Kopioi</button>
          <span class="text-xs text-slate-400">Kopioi ja liitä ChatGPT:hen.</span>
        </div>
      </div>
    </aside>

    <section class="lg:col-span-2 glass rounded-2xl border border-white/10 lg:order-2">
      <div class="px-4 py-3 border-b border-white/10 flex items-center justify-between">
        <div>
          <h2 class="font-semibold">Seuranta</h2>
          <p class="text-xs text-slate-400">Autopäivitys 60s • <span id="updated">—</span></p>
        </div>
        <div class="flex items-center gap-2">
          <input id="symbolInput" placeholder="Lisää symboli (esim. NVDA)" class="px-3 py-2 text-sm rounded-md bg-white/5 border border-white/10 placeholder:text-slate-500 focus:outline-none">
          <button id="addBtn" class="px-3 py-2 text-sm rounded-md bg-emerald-500 text-slate-900 font-semibold hover:bg-emerald-400">Lisää</button>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-white/5 text-slate-300">
            <tr>
              <th class="px-3 py-2 text-left">Symboli</th>
              <th class="px-3 py-2 text-left">Tyyppi</th>
              <th class="px-3 py-2 text-right">Hinta</th>
              <th class="px-3 py-2 text-right">RSI</th>
              <th class="px-3 py-2 text-right">Score</th>
              <th class="px-3 py-2 text-left">Entry</th>
              <th class="px-3 py-2 text-left">Tasot (EP / TP / SL)</th>
              <th class="px-3 py-2 text-left">Aika</th>
              <th class="px-3 py-2 text-left">Poista</th>
            </tr>
          </thead>
          <tbody id="signalsTbody" class="divide-y divide-white/5"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    const API = 'http://127.0.0.1:8000';

    async function api(path, opts = {}) {
      const res = await fetch(API + path, {
        headers: { 'Accept': 'application/json' },
        ...opts
      });
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }

    function formatScore(score) {
      if (score >= 70) return `<span class="score-high">${score}</span>`;
      if (score >= 40) return `<span class="score-mid">${score}</span>`;
      return `<span class="score-low">${score}</span>`;
    }

    async function loadSignals() {
      const data = await api('/signals');
      const tbody = document.getElementById('signalsTbody');
      tbody.innerHTML = '';
      for (const row of data) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-3 py-2 font-semibold">${row.symbol}</td>
          <td class="px-3 py-2">${row.type || '—'}</td>
          <td class="px-3 py-2 text-right">${row.price?.toFixed(2)}</td>
          <td class="px-3 py-2 text-right">${row.rsi?.toFixed(1)}</td>
          <td class="px-3 py-2 text-right">${formatScore(row.entry_score)}</td>
          <td class="px-3 py-2">${row.entry_side}</td>
          <td class="px-3 py-2">${row.entry_price?.toFixed(2)} / ${row.take_profit?.toFixed(2)} / ${row.stop?.toFixed(2)}</td>
          <td class="px-3 py-2">${new Date(row.time).toLocaleString()}</td>
          <td class="px-3 py-2"><button onclick="removeSymbol('${row.symbol}')" class="text-rose-400 hover:underline">Poista</button></td>
        `;
        tbody.appendChild(tr);

        const tr2 = document.createElement('tr');
        tr2.classList.add("subrow");
        tr2.innerHTML = `
          <td colspan="9" class="px-3 py-2 text-slate-400">
            MACD: ${row.macd?.toFixed(2)} | ATR: ${row.atr?.toFixed(2)} | Stoch: ${row.stoch?.toFixed(1)} | BB: ${row.bb_upper?.toFixed(2)} / ${row.bb_lower?.toFixed(2)}
          </td>
        `;
        tbody.appendChild(tr2);
      }
      document.getElementById('updated').textContent = new Date().toLocaleTimeString();
    }

    async function addSymbol() {
      const sym = document.getElementById('symbolInput').value.trim().toUpperCase();
      if (!sym) return;
      await api(`/watch/${sym}`, { method: 'POST' });
      document.getElementById('symbolInput').value = '';
      loadSignals();
    }

    async function removeSymbol(sym) {
      await api(`/watch/${sym}`, { method: 'DELETE' });
      loadSignals();
    }

    async function runScan() {
      const list = document.getElementById('scanList');
      list.innerHTML = "Haetaan...";
      try {
        const data = await api('/scan');
        list.innerHTML = data.map(s => `<div>${s.symbol} (${s.type}) - score ${formatScore(s.entry_score)}</div>`).join("");
      } catch (e) {
        list.innerHTML = "Virhe haussa";
      }
    }

    async function runSearch() {
      const q = document.getElementById('searchInput').value.trim();
      if (!q) return;
      const list = document.getElementById('scanList');
      list.innerHTML = "Haetaan...";
      try {
        const data = await api(`/search?q=${encodeURIComponent(q)}`);
        list.innerHTML = data.map(s => `<div>${s.symbol} (${s.type}) - score ${formatScore(s.entry_score)}</div>`).join("");
      } catch (e) {
        list.innerHTML = "Virhe haussa";
      }
    }

    document.getElementById('addBtn').onclick = addSymbol;
    document.getElementById('refreshBtn').onclick = loadSignals;
    document.getElementById('scanBtn').onclick = runScan;
    document.getElementById('searchBtn').onclick = runSearch;
    document.getElementById('copyPromptBtn').onclick = () => {
      const box = document.getElementById('promptBox');
      box.select();
      document.execCommand("copy");
    };

    loadSignals();
    setInterval(loadSignals, 60000);
  </script>
</body>
</html>
